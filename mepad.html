<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MePad V1 | Ruiqian Zhang</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
  <link rel="icon" href="icons/face.svg" type="image/svg+xml">

  <style>
    :root {
      --bg: #f2f0ef;
      --text: #111;
      --muted: #6b7280;
      --accent: #0b5fff;
      --hover-bg: rgba(11, 95, 255, 0.06);
      --border: rgba(16, 24, 40, 0.06);
      --section-bg: rgba(255, 255, 255, 0.4);
      --shadow-color: rgba(11, 95, 255, 0.08);
      --nav-height: 100px;
      --card-padding: 24px;
    }

    body.dark {
      --bg: #071221;
      --text: #f2f0ef;
      --muted: #98a6b3;
      --accent: #7ab7ff;
      --hover-bg: rgba(255, 255, 255, 0.06);
      --border: rgba(255, 255, 255, 0.06);
      --section-bg: rgba(255, 255, 255, 0.03);
      --shadow-color: rgba(200, 200, 200, 0.18);
    }

    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    .icon-btn, .pill, .download-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      cursor: pointer;
      user-select: none;
    }

    .icon-btn {
      border-radius: 8px;
      border: 0;
      background: transparent;
      color: var(--muted);
      overflow: hidden;
    }
    .icon-btn.square { width: 44px; height: 44px; }
    
    .icon-btn:active, .pill:active { transform: scale(0.95); background: var(--hover-bg); transition-duration: 0.1s; }

    .slot-scroller { display: flex; flex-direction: column; width: 100%; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .slot-label { height: 44px; display: flex; align-items: center; justify-content: center; width: 100%; flex-shrink: 0; }
    .icon-btn:hover .slot-scroller { transform: translateY(-44px); }

    .icon-mask {
      display: block;
      background-color: currentColor; 
      -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
      -webkit-mask-position: center; mask-position: center;
      -webkit-mask-size: contain; mask-size: contain;
    }
    
    .back-icon { 
      width: 16px; height: 16px;
      -webkit-mask-image: url('icons/up_arrow.svg'); 
      mask-image: url('icons/up_arrow.svg'); 
      transform: rotate(-90deg); 
    }

    .home-icon {
      width: 20px; height: 20px;
      -webkit-mask-image: url('icons/home.svg');
      mask-image: url('icons/home.svg');
    }
    
    .arrow-icon {
      width: 16px; height: 16px;
      -webkit-mask-image: url('icons/up_arrow.svg');
      mask-image: url('icons/up_arrow.svg');
    }

    .pill {
      padding: 6px 12px; font-size: 13px;
      border-radius: 6px;
      background: var(--section-bg);
      border: 1px solid var(--border);
      color: var(--muted);
      font-weight: 500;
    }
    
    .pill-medicine {
      padding: 8px 16px; font-size: 13px;
      border-radius: 999px;
      background: var(--section-bg);
      border: 1px solid var(--border);
      color: var(--muted);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .status-in-progress, .status-on-hold, .status-dropped, .status-completed {
        background: var(--section-bg) !important;
        border: 1px solid var(--border) !important;
        color: var(--muted) !important;
    }

    .status-in-progress::before,
    .status-on-hold::before,
    .status-dropped::before,
    .status-completed::before {
        content: '';
        display: block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .status-in-progress::before { background-color: #3b82f6; box-shadow: 0 0 6px #3b82f6; }
    .status-paused::before { background-color: #eab308; box-shadow: 0 0 6px #eab308; }
    .status-dropped::before { background-color: #ef4444; box-shadow: 0 0 6px #ef4444; }
    .status-completed::before { background-color: #22c55e; box-shadow: 0 0 6px #22c55e; }
    
    .content-card {
      padding: var(--card-padding);
      border-radius: 16px;
      background: var(--section-bg);
      border: 1px solid var(--border);
      margin-bottom: 24px;
      overflow: hidden;
    }
    .content-card h3 { font-size: 18px; color: var(--text); margin: 0 0 4px 0; }
    .content-card .meta { font-size: 13px; color: var(--muted); margin-bottom: 12px; display: block; font-family: 'Inter', monospace; }
    .content-card p { margin: 0 0 16px 0; line-height: 1.6; color: var(--muted); font-size: 15px; }
    .content-card p:last-child { margin-bottom: 0; }
    .content-card ul { margin: 0; padding-left: 20px; color: var(--muted); font-size: 15px; }
    .content-card li { margin-bottom: 6px; }
    .content-card a { color: var(--accent); text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.2s; }
    .content-card a:hover { border-bottom-color: var(--accent); }

    .req-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
      margin-bottom: 24px;
    }

    .req-item {
      display: flex;
      gap: 10px;
      padding: 16px 16px;
      border-radius: 8px;
      background: var(--section-bg);
      border: 1px solid var(--border);
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }

    .req-item-text {
      font-size: 14px;
      color: var(--text);
      line-height: 1.4;
      font-weight: 500;
    }

    @media (hover: hover) {
      .icon-btn:hover, .pill:not(.pill-accent):hover {
        background: var(--hover-bg);
        color: var(--accent);
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 6px 18px var(--shadow-color);
      }
      .content-card:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px var(--shadow-color);
        transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      }
    }

    .nav-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 0; z-index: 50; pointer-events: none; }
    .nav-right-group { position: fixed; top: 20px; right: 20px; display: flex; gap: 12px; z-index: 100; pointer-events: auto; }
    .nav-left-group { position: fixed; top: 20px; left: 20px; z-index: 100; pointer-events: auto; }

    .top-nav-bg {
      position: fixed; top: 0; left: 0; right: 0; height: var(--nav-height); z-index: 29; pointer-events: none;
      background: linear-gradient(to bottom, var(--bg) 0%, transparent 100%);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      -webkit-mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
      mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
      transition: background-color 0.32s ease;
    }

    .content-wrap { min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 120px 20px 40px 20px; box-sizing: border-box; }
    .container { width: 100%; max-width: 1100px; }

    .project-layout {
      display: flex;
      gap: 60px;
      align-items: flex-start;
      position: relative;
    }

    .project-sidebar {
      width: 30%;
      position: sticky;
      top: 130px;
      flex-shrink: 0;
    }

    .project-feed {
      width: 70%;
      flex-grow: 1;
    }

    h1 { font-size: 32px; font-weight: 800; margin-bottom: 24px; margin-top: 0px; letter-spacing: -0.5px; line-height: 1.2; }
    h2 { font-size: 20px; font-weight: 600; color: var(--accent); margin: 0 0 24px 0; }
    p.intro { color: var(--muted); margin-bottom: 24px; line-height: 1.6; font-size: 16px; }

    .tag-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 32px; margin-top: 8px; }

    .site-footer-container { text-align: center; padding-bottom: 30px; }
    .site-footer { color: var(--muted); font-size: 14px; }
    
    .scroll-to-top { 
      position: fixed; bottom: 20px; right: 20px; z-index: 100; margin: 0;
      overflow: hidden; align-items: flex-start !important; padding: 0; 
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease, transform 0.6s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
    }
    .scroll-to-top.visible { opacity: 1; pointer-events: auto; }
    .scroll-to-top .slot-label { height: 44px; width: 44px; }
    .scroll-to-top:hover .slot-scroller { transform: translateY(-44px); }

    @media (max-width: 900px) {
      .project-layout { flex-direction: column; gap: 40px; }
      .project-sidebar, .project-feed { width: 100%; position: static; }
      .req-grid { grid-template-columns: repeat(3, 1fr); }
      .scroll-to-top { position: relative; bottom: auto; right: auto; opacity: 1 !important; pointer-events: auto; margin: 0 auto 20px auto; }
    }

    @media (max-width: 768px) { .modal-nav { display: none !important; } }
    @media (max-width: 600px) { .req-grid { grid-template-columns: repeat(2, 1fr); } }

    @media (max-width: 600px) {
      .content-image,
      .content-image.square,
      .content-image-grid .content-image:first-child:last-child,
      .content-image-grid .content-image:first-child:last-child.square {
        height: 250px !important;
        width: auto !important;
        max-width: none !important;
        object-fit: fill !important;
      }
    }

    .theme-transition, .theme-transition * { 
      transition: background-color 0.32s ease, border-color 0.32s ease, color 0s, box-shadow 0.32s ease !important; 
    }

    .reveal-flip {
      opacity: 0; transform: perspective(1000px) rotateX(-45deg) translateY(30px) scale(0.95);
      transform-origin: top center;
      transition: 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .reveal-flip.visible { opacity: 1; transform: perspective(1000px) rotateX(0deg) translateY(0) scale(1); }
    .reveal-flip.reduced-opacity.visible { opacity: 0.75; }

    .char-flip {
      display: inline-block; opacity: 0; white-space: pre;
      transform: perspective(500px) rotateX(90deg) translateY(10px); transform-origin: bottom center;
      transition: 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .char-flip.visible { opacity: 1; transform: perspective(500px) rotateX(0deg) translateY(0); }

    /* IMAGE CAROUSEL */
    .content-image-grid {
      display: flex;
      gap: 8px;
      margin: 16px calc(-1 * var(--card-padding)) 20px;
      padding: 4px 0;
      overflow-x: auto;
      overflow-y: visible;
      scroll-snap-type: x mandatory;
      scroll-padding-left: var(--card-padding);
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      cursor: grab;
      user-select: none;
      touch-action: pan-y;
    }
    .content-image-grid::-webkit-scrollbar { display: none; }

    .content-image-grid .content-image:first-child { margin-left: var(--card-padding); }
    .content-image-grid .content-image:last-child { margin-right: var(--card-padding); }

    .content-image-grid.dragging { cursor: grabbing; scroll-behavior: auto; }

    .content-image {
      flex-shrink: 0;
      height: 300px;
      width: auto;
      max-width: 90%;
      border-radius: 12px;
      cursor: pointer;
      object-fit: cover;
      scroll-snap-align: start;
      border: 1px solid var(--border);
      display: block;
      /* Prevent the image itself from intercepting pointer events during drag */
      -webkit-user-drag: none;
    }

    .content-image.square { width: 300px; height: 300px; }

    /* Single image: taller display */
    .content-image-grid .content-image:first-child:last-child { height: 350px; }
    .content-image-grid .content-image:first-child:last-child.square { width: 350px; height: 350px; }

    .image-grid-wrapper { position: relative; }

    /* Prevent browser's native image drag (shows ghost + opens in new tab) */
    .content-image-grid .content-image {
      -webkit-user-drag: none;
      -user-drag: none;
      transition: transform 0.15s cubic-bezier(0.25, 1, 0.5, 1);
    }

    /* Pressed/held state — shrinks the image */
    .content-image-grid .content-image.pressing {
      transform: scale(0.94);
      transition: transform 0.12s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .image-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
      backdrop-filter: blur(8px);
      cursor: zoom-out;
    }

    .image-modal.active { display: flex; opacity: 1; align-items: center; justify-content: center; }

    .image-modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 80vh;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: default;
      transition: width 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), height 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .modal-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 44px; height: 44px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1010;
      transition: background 0.2s, transform 0.2s;
    }
    .modal-nav:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-50%) scale(1.1); }
    .modal-nav:active { transform: translateY(-50%) scale(0.95); }
    .modal-nav.prev { left: 24px; }
    .modal-nav.next { right: 24px; }
    
    .modal-arrow-icon {
      width: 20px; height: 20px; background: white;
      -webkit-mask: url('icons/up_arrow.svg') no-repeat center / contain;
      mask: url('icons/up_arrow.svg') no-repeat center / contain;
    }
    .modal-nav.prev .modal-arrow-icon { transform: rotate(-90deg); }
    .modal-nav.next .modal-arrow-icon { transform: rotate(90deg); }

    @keyframes wipe-enter {
      0%   { clip-path: circle(0% at 50% 50%); transform: scale(0.95); opacity: 0.5; }
      100% { clip-path: circle(150% at 50% 50%); transform: scale(1); opacity: 1; }
    }

    .image-modal-img {
      max-width: 100%;
      max-height: 80vh;
      width: auto; height: auto;
      border-radius: 12px;
      display: block;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    .animate-wipe { animation: wipe-enter 0.5s cubic-bezier(0.23, 1, 0.32, 1) forwards; }
  </style>
</head>
<body>
  
  <script>
    (function() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.body.style.transition = 'none';
      if (saved === 'dark' || (!saved && prefersDark)) document.body.classList.add('dark');
    })();
  </script>

  <div class="top-nav-bg"></div>

  <nav class="nav-wrapper">
    <div class="nav-left-group">
      <a href="projects.html" class="icon-btn square" aria-label="Back to Projects">
        <div class="icon-mask back-icon"></div>
      </a>
    </div>
    <div class="nav-right-group">
      <a href="https://rhemzema.github.io" class="icon-btn square" aria-label="Go to Home">
        <div class="icon-mask home-icon"></div>
      </a>
      <button id="theme-toggle" class="icon-btn square" aria-label="Toggle dark mode">
        <svg width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 22C17.5228 22 22 17.5228 22 12C22 11.5373 21.3065 11.4608 21.0672 11.8568C19.9289 13.7406 17.8615 15 15.5 15C11.9101 15 9 12.0899 9 8.5C9 6.13845 10.2594 4.07105 12.1432 2.93276C12.5392 2.69347 12.4627 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="currentColor"/>
        </svg>
      </button>
    </div>
  </nav>

  <div class="content-wrap">
    <div class="container">
      <div class="project-layout">
        <aside class="project-sidebar">
          <h1 class="split-flip-text">MePad V1</h1>
          <div class="tag-row reveal-flip">
            <span class="pill-medicine no-hover status-in-progress">In Progress</span>
            <span class="pill-medicine no-hover">Start Date: Jan 3, 2026</span>
          </div>
          <p class="intro reveal-flip">Welcome to my personal project, MePad! My take on the macro keypad.</p>
          <p class="intro reveal-flip">My primary objective is to explore the entire process of product development from identifying user needs to hardware design and software implementation.</p>
          <div class="reveal-flip">
            <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--text);">Basic Requirements</h3>
            <div class="req-grid">
              <div class="req-item"><span class="req-item-text">Compact Design</span></div>
              <div class="req-item"><span class="req-item-text">Hotswap Switches</span></div>
              <div class="req-item"><span class="req-item-text">Audio Controls</span></div>
              <div class="req-item"><span class="req-item-text">2 USB Ports</span></div>
              <div class="req-item"><span class="req-item-text">Multiple Switches</span></div>
              <div class="req-item"><span class="req-item-text">Cheap</span></div>
            </div>
          </div>
        </aside>

        <section class="project-feed">
          <h2 class="reveal-flip">Dev Log</h2>

          <div class="content-card reveal-flip">
            <h3>Day 1: Layout Design</h3>
            <span class="meta">Jan 3, 2026</span>
            <div class="image-grid-wrapper">
              <div class="content-image-grid">
                <img src="assets/MePad_Layout.jpg" alt="MePad Layout Design" class="content-image" draggable="false" />
              </div>
            </div>
            <p>Day one was the day I decided to start the project on a whim. I focused on researching and taking inspiration from online resources like Bilibili.</p>
            <p>I set the initial layout for the keypad using <a href="http://keyboard-layout-editor.com" target="_blank">keyboard-layout-editor.com</a>. The plan is to have 9 custom regular switch keys and 2 scroll knobs—one for audio controls and one for scrolling through webpages or Premiere Pro timelines.</p>
          </div>

          <div class="content-card reveal-flip">
            <h3>Day 2: PCB Schematics & Firmware</h3>
            <span class="meta">Jan 5, 2026</span>
            <div class="image-grid-wrapper">
              <div class="content-image-grid">
                <img src="assets/MePad_Matrix.jpg" alt="MePad Switch Matrix" class="content-image" draggable="false" />
                <img src="assets/MePad_Schematic.png" alt="MePad PCB Day 2" class="content-image" draggable="false" />
              </div>
            </div>
            <p>Today was a big day for learning and design. I dived into the electrical engineering side of keyboards:</p>
            <ul>
              <li>Learned how to optimize microcontroller connections using a switch matrix.</li>
              <li>Implemented diodes to avoid input ghosting.</li>
              <li>Built initial keyboard firmware with <a href="https://kbfirmware.com" target="_blank">kbfirmware.com</a>.</li>
              <li>Designed the PCB footprint using Autodesk Fusion 360 (Knobs: Top 15mm, Bottom 32mm).</li>
              <li>Finished PCB schematics with EasyEDA centered on the ATmega32U4 microcontroller.</li>
            </ul>
          </div>

          <div class="content-card reveal-flip">
            <h3>Day 3: Component Placement</h3>
            <span class="meta">Jan 6, 2026</span>
            <div class="image-grid-wrapper">
              <div class="content-image-grid">
                <img src="assets/MePad_PCB_Day2.png" alt="MePad PCB Day 3" class="content-image" draggable="false" />
              </div>
            </div>
            <p>Started work on component placement and ensuring components on the board fits within the planned housing constraints.</p>
          </div>

          <div class="content-card reveal-flip">
            <h3>Day 4: PCB Wiring</h3>
            <span class="meta">Jan 9, 2026</span>
            <div class="image-grid-wrapper">
              <div class="content-image-grid">
                <img src="assets/MePad_PCB_Day3.png" alt="MePad PCB Day 4" class="content-image" draggable="false" />
              </div>
            </div>
            <p>Started work on the wiring and routing of the PCB.</p>
          </div>

          <div class="content-card reveal-flip reduced-opacity" style="text-align: center;">
            <h3 style="font-size: 20px; margin-bottom: 8px;">To be continued...</h3>
            <p style="color: var(--muted); font-size: 14px; margin: 0;">More updates coming soon.</p>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div class="image-modal" id="image-modal">
    <div class="modal-nav prev" id="modal-prev" style="display: none;"><div class="modal-arrow-icon"></div></div>
    <div class="modal-nav next" id="modal-next" style="display: none;"><div class="modal-arrow-icon"></div></div>
    <div class="image-modal-content" id="modal-content">
      <img id="modal-image" class="image-modal-img animate-wipe" src="" alt="" />
    </div>
  </div>

  <div class="site-footer-container">
    <button class="icon-btn square scroll-to-top" id="scroll-to-top" aria-label="Scroll to top">
      <span class="slot-scroller">
        <span class="slot-label"><div class="icon-mask arrow-icon"></div></span>
        <span class="slot-label"><div class="icon-mask arrow-icon"></div></span>
      </span>
    </button>
    <footer class="site-footer">&copy; 2026 Ruiqian Zhang</footer>
  </div>

  <script>
    const UI = {
      body: document.body,
      toggleBtn: document.getElementById('theme-toggle'),
      scrollBtn: document.getElementById('scroll-to-top')
    };

    window.addEventListener('load', () => {
      setTimeout(() => UI.body.style.transition = '', 100);
      const chars = document.querySelectorAll('.char-flip');
      chars.forEach((c, i) => setTimeout(() => c.classList.add('visible'), i * 30));
      setTimeout(() => {
        const sidebarItems = document.querySelectorAll('.project-sidebar .reveal-flip');
        const feedItems = document.querySelectorAll('.project-feed .reveal-flip');
        const maxLen = Math.max(sidebarItems.length, feedItems.length);
        for (let i = 0; i < maxLen; i++) {
          const delay = i * 150;
          if (sidebarItems[i]) setTimeout(() => sidebarItems[i].classList.add('visible'), delay);
          if (feedItems[i]) setTimeout(() => feedItems[i].classList.add('visible'), delay);
        }
      }, 300);
    });

    UI.toggleBtn.addEventListener('click', () => {
      UI.body.classList.add('theme-transition');
      const isDark = UI.body.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      setTimeout(() => UI.body.classList.remove('theme-transition'), 420);
    });

    function smoothScrollToTop() {
      const duration = 800;
      const startY = window.scrollY;
      const distance = -startY;
      let startTime = null;
      function animation(currentTime) {
        if (startTime === null) startTime = currentTime;
        const timeElapsed = currentTime - startTime;
        const progress = Math.min(timeElapsed / duration, 1);
        const ease = progress < 0.5 ? 4 * progress * progress * progress : 1 - Math.pow(-2 * progress + 2, 3) / 2;
        window.scrollTo(0, startY + (distance * ease));
        if (timeElapsed < duration) requestAnimationFrame(animation);
      }
      requestAnimationFrame(animation);
    }
    UI.scrollBtn.addEventListener('click', smoothScrollToTop);

    window.addEventListener('scroll', () => {
      const scrollPosition = window.innerHeight + window.scrollY;
      const bottomPosition = document.body.offsetHeight - 100;
      UI.scrollBtn.classList.toggle('visible', scrollPosition >= bottomPosition);
    });

    document.querySelectorAll('.split-flip-text').forEach(el => {
      const text = el.textContent;
      el.setAttribute('aria-label', text);
      el.innerHTML = '';
      text.split('').forEach(char => {
        const span = document.createElement('span');
        span.className = 'char-flip';
        span.textContent = char;
        el.appendChild(span);
      });
    });

    // ── Image Modal state ────────────────────────────────────────────────
    const imageModal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const modalContent = document.getElementById('modal-content');
    const prevBtn = document.getElementById('modal-prev');
    const nextBtn = document.getElementById('modal-next');
    let currentGalleryImages = [], currentImageIndex = 0;

    function openModal(img, grid) {
      currentGalleryImages = grid ? Array.from(grid.querySelectorAll('.content-image')) : [img];
      currentImageIndex = currentGalleryImages.indexOf(img);
      updateModalContent(currentImageIndex);
      imageModal.classList.add('active');
      document.body.style.overflow = 'hidden';
      updateArrowVisibility();
    }
    function updateModalContent(index) {
      const src = currentGalleryImages[index];
      modalImage.classList.remove('animate-wipe');
      void modalImage.offsetWidth;
      modalImage.src = src.src;
      modalImage.alt = src.alt;
      modalImage.classList.add('animate-wipe');
    }
    function updateArrowVisibility() {
      if (currentGalleryImages.length <= 1) { prevBtn.style.display = nextBtn.style.display = 'none'; return; }
      prevBtn.style.display = currentImageIndex > 0 ? 'flex' : 'none';
      nextBtn.style.display = currentImageIndex < currentGalleryImages.length - 1 ? 'flex' : 'none';
    }
    function nextImage(e) { if (e) e.stopPropagation(); if (currentImageIndex < currentGalleryImages.length - 1) { currentImageIndex++; updateModalContent(currentImageIndex); updateArrowVisibility(); } }
    function prevImage(e) { if (e) e.stopPropagation(); if (currentImageIndex > 0) { currentImageIndex--; updateModalContent(currentImageIndex); updateArrowVisibility(); } }
    function closeModal() { imageModal.classList.remove('active'); document.body.style.overflow = ''; }

    nextBtn.addEventListener('click', nextImage);
    prevBtn.addEventListener('click', prevImage);
    document.addEventListener('keydown', (e) => {
      if (!imageModal.classList.contains('active')) return;
      if (e.key === 'ArrowRight') nextImage(e);
      if (e.key === 'ArrowLeft') prevImage(e);
      if (e.key === 'Escape') closeModal();
    });
    let touchStartX = 0, touchEndX = 0;
    imageModal.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
    imageModal.addEventListener('touchend', (e) => { touchEndX = e.changedTouches[0].screenX; if (touchEndX < touchStartX - 50) nextImage(); if (touchEndX > touchStartX + 50) prevImage(); }, { passive: true });
    imageModal.addEventListener('click', (e) => { if (e.target === imageModal || e.target === modalContent) closeModal(); });

    // Prevent native browser image drag (would show ghost + allow open-in-new-tab)
    document.querySelectorAll('.content-image-grid .content-image').forEach(img => {
      img.addEventListener('dragstart', (e) => e.preventDefault());
    });

    // ── Square image detection ───────────────────────────────────────────
    document.querySelectorAll('.content-image').forEach(img => {
      const check = () => { if (img.naturalWidth === img.naturalHeight && img.naturalWidth > 0) img.classList.add('square'); };
      if (img.complete) check(); else img.addEventListener('load', check);
    });

    // ── Carousel drag — single window-level handler ──────────────────────
    // One active drag at a time; drag can start from anywhere inside the grid
    // (including on top of images). A tap (< DRAG_THRESHOLD px) opens the modal.
    const DRAG_THRESHOLD = 6;
    let dragGrid = null;   // which grid is being dragged
    let dragDown = false;
    let dragDidMove = false;
    let dragStartX = 0, dragScrollStart = 0;
    let dragLastX = 0, dragLastT = 0;
    let dragVelX = 0, dragMomentumID;
    const dragSamples = [];
    let snapTimer;
    let pressedImg = null; // image currently being held down

    function setPressedImg(img) {
      if (pressedImg && pressedImg !== img) pressedImg.classList.remove('pressing');
      pressedImg = img;
      if (pressedImg) pressedImg.classList.add('pressing');
    }
    function clearPressedImg() {
      if (pressedImg) pressedImg.classList.remove('pressing');
      pressedImg = null;
    }

    function carouselDisableSnap() {
      if (!dragGrid) return;
      dragGrid.style.scrollSnapType = 'none';
      clearTimeout(snapTimer);
    }
    function carouselRestoreSnap() {
      clearTimeout(snapTimer);
      snapTimer = setTimeout(() => { if (dragGrid) dragGrid.style.scrollSnapType = ''; }, 150);
    }
    function carouselMomentum() {
      if (!dragGrid || Math.abs(dragVelX) < 0.3) {
        dragVelX = 0;
        carouselRestoreSnap();
        dragGrid = null;
        return;
      }
      dragGrid.scrollLeft += dragVelX;
      dragVelX *= 0.88;
      dragMomentumID = requestAnimationFrame(carouselMomentum);
    }

    // Pointerdown: start drag on any grid (or image inside it)
    document.querySelectorAll('.content-image-grid').forEach(grid => {
      // Wheel / touchpad
      let snapDebounce;
      grid.addEventListener('wheel', (e) => {
        if (Math.abs(e.deltaX) > 2) {
          e.preventDefault();
          cancelAnimationFrame(dragMomentumID);
          grid.style.scrollBehavior = 'auto';
          grid.style.scrollSnapType = 'none';
          grid.scrollLeft += e.deltaX * 0.5;
          clearTimeout(snapDebounce);
          snapDebounce = setTimeout(() => { grid.style.scrollSnapType = ''; }, 150);
        }
      }, { passive: false });

      grid.addEventListener('pointerdown', (e) => {
        if (e.button !== 0 && e.pointerType === 'mouse') return;
        cancelAnimationFrame(dragMomentumID);
        dragGrid = grid;
        dragDown = true;
        dragDidMove = false;
        dragStartX = e.clientX;
        dragScrollStart = grid.scrollLeft;
        dragLastX = e.clientX;
        dragLastT = e.timeStamp;
        dragVelX = 0;
        dragSamples.length = 0;
        grid.style.scrollBehavior = 'auto';
        carouselDisableSnap();
        grid.classList.add('dragging');
        // Press animation: shrink the image under the pointer
        const target = document.elementFromPoint(e.clientX, e.clientY);
        const img = target && target.closest('.content-image');
        if (img) setPressedImg(img);
        // Only capture mouse pointers — capturing touch pointers causes
        // pointercancel to fire on scroll-like gestures, killing the tap
        if (e.pointerType === 'mouse') grid.setPointerCapture(e.pointerId);
      });

      // Track touch drag distance so we know if it's a swipe or a tap
      let touchStartX = 0;
      grid.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        dragDidMove = false;
      }, { passive: true });

      grid.addEventListener('touchmove', (e) => {
        if (Math.abs(e.touches[0].clientX - touchStartX) > DRAG_THRESHOLD) {
          dragDidMove = true;
        }
      }, { passive: true });

      // Native click handler for opening the modal
      grid.addEventListener('click', (e) => {
        // If the user was dragging the carousel, ignore the click
        if (dragDidMove) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        const img = e.target.closest('.content-image');
        if (img) {
          openModal(img, grid);
        }
      });
    });

    // Single window-level move + up
    window.addEventListener('pointermove', (e) => {
      if (!dragDown || !dragGrid) return;
      const dx = e.clientX - dragStartX;
      if (Math.abs(dx) > DRAG_THRESHOLD) {
        dragDidMove = true;
        clearPressedImg(); // moved too far — release the press visual
      }
      if (!dragDidMove) {
        // Still within tap threshold — check if pointer left the pressed image
        if (pressedImg) {
          const target = document.elementFromPoint(e.clientX, e.clientY);
          const stillOn = target && target.closest('.content-image') === pressedImg;
          if (!stillOn) clearPressedImg(); // pointer slid off image — cancel press + modal
        }
        return;
      }
      e.preventDefault();
      dragGrid.scrollLeft = dragScrollStart - dx * 0.65;
      const dt = Math.max(e.timeStamp - dragLastT, 1);
      dragSamples.push(((dragLastX - e.clientX) / dt) * 16 * 0.5);
      if (dragSamples.length > 6) dragSamples.shift();
      dragLastX = e.clientX;
      dragLastT = e.timeStamp;
    }, { passive: false });

    window.addEventListener('pointerup', (e) => {
      if (!dragDown) return;
      dragDown = false;
      if (dragGrid) dragGrid.classList.remove('dragging');

      if (dragSamples.length > 0) dragVelX = dragSamples.reduce((a, b) => a + b, 0) / dragSamples.length;
      carouselMomentum();

      clearPressedImg();
    });

    window.addEventListener('pointercancel', () => {
      if (!dragDown) return;
      dragDown = false;
      clearPressedImg();
      if (dragGrid) { dragGrid.classList.remove('dragging'); carouselRestoreSnap(); }
    });
  </script>
</body>
</html>